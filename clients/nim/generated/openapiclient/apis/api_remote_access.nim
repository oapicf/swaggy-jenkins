#
# Swaggy Jenkins
# 
# Jenkins API clients generated from Swagger / Open API specification
# The version of the OpenAPI document: 3.2.1-pre.0
# Contact: blah+oapicf@cliffano.com
# Generated by: https://openapi-generator.tech
#

import httpclient
import json
import logging
import marshal
import options
import strformat
import strutils
import tables
import typetraits
import uri

import ../models/model_computer_set
import ../models/model_free_style_build
import ../models/model_free_style_project
import ../models/model_hudson
import ../models/model_list_view
import ../models/model_queue

const basepath = "http://localhost"

template constructResult[T](response: Response): untyped =
  if response.code in {Http200, Http201, Http202, Http204, Http206}:
    try:
      (some(to(parseJson(response.body), T)), response)
    except JsonParsingError:
      # The server returned a malformed response though the response code is 2XX
      # TODO: need better error handling
      error("JsonParsingError")
      (none(T.typedesc), response)
  else:
    (none(T.typedesc), response)


proc getComputer*(httpClient: HttpClient, depth: int): (Option[ComputerSet], Response) =
  ## 
  var query_params_list: seq[(string, string)] = @[]
  query_params_list.add(("depth", $depth))
  let url_encoded_query_params = encodeQuery(query_params_list)

  let response = httpClient.get(basepath & "/computer/api/json" & "?" & url_encoded_query_params)
  constructResult[ComputerSet](response)


proc getJenkins*(httpClient: HttpClient): (Option[Hudson], Response) =
  ## 

  let response = httpClient.get(basepath & "/api/json")
  constructResult[Hudson](response)


proc getJob*(httpClient: HttpClient, name: string): (Option[FreeStyleProject], Response) =
  ## 

  let response = httpClient.get(basepath & fmt"/job/{name}/api/json")
  constructResult[FreeStyleProject](response)


proc getJobConfig*(httpClient: HttpClient, name: string): (Option[string], Response) =
  ## 

  let response = httpClient.get(basepath & fmt"/job/{name}/config.xml")
  constructResult[string](response)


proc getJobLastBuild*(httpClient: HttpClient, name: string): (Option[FreeStyleBuild], Response) =
  ## 

  let response = httpClient.get(basepath & fmt"/job/{name}/lastBuild/api/json")
  constructResult[FreeStyleBuild](response)


proc getJobProgressiveText*(httpClient: HttpClient, name: string, number: string, start: string): Response =
  ## 
  var query_params_list: seq[(string, string)] = @[]
  query_params_list.add(("start", $start))
  let url_encoded_query_params = encodeQuery(query_params_list)
  httpClient.get(basepath & fmt"/job/{name}/{number}/logText/progressiveText" & "?" & url_encoded_query_params)



proc getQueue*(httpClient: HttpClient): (Option[Queue], Response) =
  ## 

  let response = httpClient.get(basepath & "/queue/api/json")
  constructResult[Queue](response)


proc getQueueItem*(httpClient: HttpClient, number: string): (Option[Queue], Response) =
  ## 

  let response = httpClient.get(basepath & fmt"/queue/item/{number}/api/json")
  constructResult[Queue](response)


proc getView*(httpClient: HttpClient, name: string): (Option[ListView], Response) =
  ## 

  let response = httpClient.get(basepath & fmt"/view/{name}/api/json")
  constructResult[ListView](response)


proc getViewConfig*(httpClient: HttpClient, name: string): (Option[string], Response) =
  ## 

  let response = httpClient.get(basepath & fmt"/view/{name}/config.xml")
  constructResult[string](response)


proc headJenkins*(httpClient: HttpClient): Response =
  ## 
  httpClient.head(basepath & "/api/json")



proc postCreateItem*(httpClient: HttpClient, name: string, `from`: string, mode: string, jenkinsCrumb: string, contentType: string, body: string): Response =
  ## 
  httpClient.headers["Content-Type"] = "application/json"
  httpClient.headers["Jenkins-Crumb"] = jenkinsCrumb
  httpClient.headers["Content-Type"] = contentType
  var query_params_list: seq[(string, string)] = @[]
  query_params_list.add(("name", $name))
  if $`from` != "":
    query_params_list.add(("from", $`from`))
  if $mode != "":
    query_params_list.add(("mode", $mode))
  let url_encoded_query_params = encodeQuery(query_params_list)
  httpClient.post(basepath & "/createItem" & "?" & url_encoded_query_params, $(%body))



proc postCreateView*(httpClient: HttpClient, name: string, jenkinsCrumb: string, contentType: string, body: string): Response =
  ## 
  httpClient.headers["Content-Type"] = "application/json"
  httpClient.headers["Jenkins-Crumb"] = jenkinsCrumb
  httpClient.headers["Content-Type"] = contentType
  var query_params_list: seq[(string, string)] = @[]
  query_params_list.add(("name", $name))
  let url_encoded_query_params = encodeQuery(query_params_list)
  httpClient.post(basepath & "/createView" & "?" & url_encoded_query_params, $(%body))



proc postJobBuild*(httpClient: HttpClient, name: string, json: string, token: string, jenkinsCrumb: string): Response =
  ## 
  httpClient.headers["Jenkins-Crumb"] = jenkinsCrumb
  var query_params_list: seq[(string, string)] = @[]
  query_params_list.add(("json", $json))
  if $token != "":
    query_params_list.add(("token", $token))
  let url_encoded_query_params = encodeQuery(query_params_list)
  httpClient.post(basepath & fmt"/job/{name}/build" & "?" & url_encoded_query_params)



proc postJobConfig*(httpClient: HttpClient, name: string, body: string, jenkinsCrumb: string): Response =
  ## 
  httpClient.headers["Content-Type"] = "application/json"
  httpClient.headers["Jenkins-Crumb"] = jenkinsCrumb
  httpClient.post(basepath & fmt"/job/{name}/config.xml", $(%body))



proc postJobDelete*(httpClient: HttpClient, name: string, jenkinsCrumb: string): Response =
  ## 
  httpClient.headers["Jenkins-Crumb"] = jenkinsCrumb
  httpClient.post(basepath & fmt"/job/{name}/doDelete")



proc postJobDisable*(httpClient: HttpClient, name: string, jenkinsCrumb: string): Response =
  ## 
  httpClient.headers["Jenkins-Crumb"] = jenkinsCrumb
  httpClient.post(basepath & fmt"/job/{name}/disable")



proc postJobEnable*(httpClient: HttpClient, name: string, jenkinsCrumb: string): Response =
  ## 
  httpClient.headers["Jenkins-Crumb"] = jenkinsCrumb
  httpClient.post(basepath & fmt"/job/{name}/enable")



proc postJobLastBuildStop*(httpClient: HttpClient, name: string, jenkinsCrumb: string): Response =
  ## 
  httpClient.headers["Jenkins-Crumb"] = jenkinsCrumb
  httpClient.post(basepath & fmt"/job/{name}/lastBuild/stop")



proc postViewConfig*(httpClient: HttpClient, name: string, body: string, jenkinsCrumb: string): Response =
  ## 
  httpClient.headers["Content-Type"] = "application/json"
  httpClient.headers["Jenkins-Crumb"] = jenkinsCrumb
  httpClient.post(basepath & fmt"/view/{name}/config.xml", $(%body))


